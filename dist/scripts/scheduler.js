// Scheduler for WhatsApp reminders - Standalone CRON job
require('dotenv').config()
const { PrismaClient } = require('@prisma/client')
const prisma = new PrismaClient()

// Import timezone functions (converted to CommonJS)
function getBrazilNow() {
  const now = new Date()
  // Ajustar para timezone brasileiro (-3 UTC)
  const brazilOffset = -3 * 60 // -180 minutes
  const utc = now.getTime() + (now.getTimezoneOffset() * 60000)
  return new Date(utc + (brazilOffset * 60000))
}

function formatBrazilDate(date) {
  return date.toLocaleDateString('pt-BR', {
    day: '2-digit',
    month: '2-digit',
    year: 'numeric'
  })
}

function formatBrazilTime(date) {
  return date.toLocaleTimeString('pt-BR', {
    hour: '2-digit',
    minute: '2-digit',
    hour12: false
  })
}

function generateId() {
  return require('crypto').randomBytes(12).toString('base64url')
}

function formatCurrency(value) {
  return new Intl.NumberFormat('pt-BR', {
    style: 'currency',
    currency: 'BRL'
  }).format(value)
}

// WhatsApp templates (CommonJS version)
const whatsappTemplates = {
  reminder24h: (data) => `üîî *Lembrete: Agendamento Amanh√£!*

Ol√° *${data.clientName}*! üòä

Este √© um lembrete do seu agendamento na *${data.businessName}*:

üìÖ *Amanh√£ - ${data.date}*
‚è∞ Hor√°rio: ${data.time}
üîπ Servi√ßo: ${data.service}
üë®‚Äçüíº Profissional: ${data.professional}

üí° Lembre-se de chegar 10 minutos antes!

Qualquer imprevisto, entre em contato conosco! üì±`,

  reminder12h: (data) => `‚è∞ *Lembrete: Seu hor√°rio √© hoje!*

Ol√° *${data.clientName}*!

Seu agendamento na *${data.businessName}* √© hoje:

üìÖ *Hoje - ${data.date}*
‚è∞ Hor√°rio: ${data.time}  
üîπ Servi√ßo: ${data.service}
üë®‚Äçüíº Profissional: ${data.professional}

Estamos te esperando! üòä`,

  reminder2h: (data) => `‚ö° *Lembrete: Seu hor√°rio √© em 2 horas!*

Ol√° *${data.clientName}*!

N√£o esque√ßa do seu agendamento:

‚è∞ *${data.time}* (em 2 horas)
üîπ Servi√ßo: ${data.service}  
üë®‚Äçüíº Profissional: ${data.professional}

J√° estamos nos preparando para te receber! üéØ`
}

// Phone formatting
function formatPhoneNumber(phone) {
  if (!phone) return ""
  
  const cleaned = phone.replace(/\D/g, '')
  console.log(`üì± Formatando telefone: ${phone} -> ${cleaned}`)
  
  if (cleaned.length === 13 && cleaned.startsWith('55')) {
    return cleaned
  } else if (cleaned.length === 11 && cleaned.startsWith('11')) {
    return `55${cleaned}`
  } else if (cleaned.length === 10) {
    const areaCode = cleaned.substring(0, 2)
    const number = cleaned.substring(2)
    return `55${areaCode}9${number}`
  } else if (cleaned.length === 9) {
    return `5511${cleaned}`
  }
  
  return cleaned
}

// Evolution API call
async function sendWhatsAppMessage(message) {
  try {
    console.log(`üì§ [CRON] Enviando mensagem WhatsApp...`)
    console.log(`üì± Para: ${message.to}`)
    console.log(`üìù Tipo: ${message.type}`)

    const EVOLUTION_API_URL = process.env.EVOLUTION_API_URL
    const EVOLUTION_API_KEY = process.env.EVOLUTION_API_KEY
    const EVOLUTION_INSTANCE = process.env.EVOLUTION_INSTANCE

    if (!EVOLUTION_API_URL || !EVOLUTION_API_KEY || !EVOLUTION_INSTANCE) {
      console.error('‚ùå [CRON] Configura√ß√£o Evolution API incompleta')
      return false
    }

    const formattedPhone = formatPhoneNumber(message.to)
    
    const payload = {
      number: formattedPhone,
      text: message.message
    }

    const response = await fetch(`${EVOLUTION_API_URL}/message/sendText/${EVOLUTION_INSTANCE}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'apikey': EVOLUTION_API_KEY
      },
      body: JSON.stringify(payload)
    })

    console.log('üìã [CRON] Response status:', response.status)

    if (response.ok) {
      const responseData = await response.json()
      console.log('‚úÖ [CRON] Mensagem enviada com sucesso')
      return true
    } else {
      const errorData = await response.json().catch(() => ({ message: 'Erro desconhecido' }))
      console.error('‚ùå [CRON] Erro ao enviar mensagem:', response.status, errorData)
      return false
    }

  } catch (error) {
    console.error('‚ùå [CRON] Erro ao conectar com Evolution API:', error)
    return false
  }
}

// Reminder configurations
const REMINDER_CONFIGS = [
  {
    type: 'reminder_24h',
    hoursBefore: 24,
    minutesBefore: 0,
    template: 'reminder24h'
  },
  {
    type: 'reminder_12h',
    hoursBefore: 12,
    minutesBefore: 0,
    template: 'reminder12h'
  },
  {
    type: 'reminder_2h',
    hoursBefore: 2,
    minutesBefore: 0,
    template: 'reminder2h'
  }
]

// Main reminder processing function
async function sendWhatsappReminders() {
  console.log('üöÄ [CRON] Iniciando processamento de lembretes...')
  console.log(`[${new Date().toISOString()}] CRON JOB EXECUTADO`)
  
  const now = getBrazilNow()
  let totalSent = 0

  for (const config of REMINDER_CONFIGS) {
    try {
      console.log(`üìã [CRON] Processando ${config.type}...`)
      
      // Calcular janela de tempo
      const exactTime = new Date(now)
      exactTime.setHours(exactTime.getHours() + config.hoursBefore, config.minutesBefore, 0, 0)
      
      // Janela de 10 minutos para capturar agendamentos
      const windowStart = new Date(exactTime)
      windowStart.setMinutes(windowStart.getMinutes() - 5)
      
      const windowEnd = new Date(exactTime)
      windowEnd.setMinutes(windowEnd.getMinutes() + 5)

      console.log(`üîç [CRON] Buscando agendamentos entre ${windowStart.toISOString()} e ${windowEnd.toISOString()}`)

      // Buscar agendamentos
      const appointments = await prisma.appointment.findMany({
        where: {
          dateTime: {
            gte: windowStart,
            lte: windowEnd,
          },
          status: {
            in: ['SCHEDULED', 'CONFIRMED']
          }
        },
        include: {
          tenant: {
            select: {
              id: true,
              businessName: true,
              businessPhone: true,
            }
          },
          endUser: {
            select: {
              id: true,
              name: true,
              phone: true,
            }
          },
          professional: {
            select: {
              id: true,
              name: true,
            }
          },
          services: {
            select: {
              id: true,
              name: true,
              price: true,
              duration: true,
            }
          }
        }
      })

      console.log(`üìã [CRON] Encontrados ${appointments.length} agendamentos no per√≠odo`)

      // Filtrar e enviar lembretes
      for (const appointment of appointments) {
        try {
          // Verificar se automa√ß√£o est√° ativa
          const automationSetting = await prisma.$queryRaw`
            SELECT * FROM automation_settings 
            WHERE establishmentId = ${appointment.tenantId} 
            AND automationType = ${config.type} 
            AND isEnabled = true
            LIMIT 1
          `
          
          if (automationSetting.length === 0) {
            console.log(`‚ö†Ô∏è [CRON] Automa√ß√£o ${config.type} desabilitada para ${appointment.tenant.businessName}`)
            continue
          }

          // Verificar se j√° foi enviado
          const existingReminder = await prisma.$queryRaw`
            SELECT * FROM appointment_reminders 
            WHERE appointmentId = ${appointment.id} 
            AND reminderType = ${config.type}
            LIMIT 1
          `
          
          if (existingReminder.length > 0) {
            console.log(`‚úÖ [CRON] Lembrete ${config.type} j√° enviado para agendamento ${appointment.id}`)
            continue
          }

          // Verificar telefone
          if (!appointment.endUser.phone) {
            console.log(`‚ùå [CRON] Cliente ${appointment.endUser.name} n√£o possui telefone`)
            continue
          }

          // Preparar dados do template
          const appointmentDate = new Date(appointment.dateTime)
          const templateData = {
            clientName: appointment.endUser.name,
            businessName: appointment.tenant.businessName || 'Nossa Barbearia',
            service: appointment.services.map(s => s.name).join(', '),
            professional: appointment.professional?.name || 'Profissional',
            date: formatBrazilDate(appointmentDate),
            time: formatBrazilTime(appointmentDate)
          }

          // Gerar e enviar mensagem
          const message = whatsappTemplates[config.template](templateData)
          
          const success = await sendWhatsAppMessage({
            to: appointment.endUser.phone,
            message,
            type: 'reminder'
          })

          if (success) {
            // Registrar envio
            await prisma.$executeRaw`
              INSERT INTO appointment_reminders (id, appointmentId, reminderType, sentAt, createdAt)
              VALUES (${generateId()}, ${appointment.id}, ${config.type}, ${now}, ${now})
            `

            totalSent++
            console.log(`‚úÖ [CRON] Lembrete ${config.type} enviado para ${appointment.endUser.name}`)
            
            // Delay entre envios
            await new Promise(resolve => setTimeout(resolve, 1000))
          }

        } catch (error) {
          console.error(`‚ùå [CRON] Erro ao processar agendamento ${appointment.id}:`, error)
        }
      }

    } catch (error) {
      console.error(`‚ùå [CRON] Erro ao processar ${config.type}:`, error)
    }
  }

  console.log(`‚úÖ [CRON] Processamento conclu√≠do. Total de lembretes enviados: ${totalSent}`)
  return totalSent
}

// Execute and exit
sendWhatsappReminders()
  .then((totalSent) => {
    console.log(`üéØ [CRON] CRON job conclu√≠do. ${totalSent} lembretes enviados.`)
    process.exit(0)
  })
  .catch((error) => {
    console.error('‚ùå [CRON] Erro fatal no cron job:', error)
    process.exit(1)
  })
  .finally(async () => {
    await prisma.$disconnect()
  })
