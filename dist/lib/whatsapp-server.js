"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.whatsappTemplates = void 0;
exports.sendWhatsAppMessage = sendWhatsAppMessage;
exports.formatPhoneNumber = formatPhoneNumber;
exports.checkWhatsAppStatus = checkWhatsAppStatus;
exports.scheduleReminders = scheduleReminders;
// WhatsApp API integration utilities
const currency_1 = require("./currency");
// WhatsApp message templates (UNIFICADOS com whatsapp-server.ts)
exports.whatsappTemplates = {
    confirmation: (data) => `‚úÖ *Agendamento Confirmado!*

Ol√° *${data.clientName}*! üòä

Seu agendamento na *${data.businessName}* foi confirmado com sucesso!

üìã *Detalhes:*
üîπ Servi√ßo: ${data.service}
üë®‚Äçüíº Profissional: ${data.professional}
üóìÔ∏è Data: ${data.date}
‚è∞ Hor√°rio: ${data.time}
‚è≥ Dura√ß√£o: ${data.totalTime} min
üí∞ Valor: ${(0, currency_1.formatCurrency)(data.price)}

üí° *Lembre-se:*
‚Ä¢ Chegue 10 min antes do hor√°rio
‚Ä¢ Em caso de cancelamento, avise com anteced√™ncia

Obrigado pela prefer√™ncia! üôè
Nos vemos em breve! üéâ`,
    reminder24h: (data) => `üîî *N√£o esque√ßa: voc√™ tem um hor√°rio marcado!*

Ol√° *${data.clientName}*! üòä

Este √© um lembrete do seu agendamento na *${data.businessName}*:

üóìÔ∏è *Data: ${data.date}*
‚è∞ Hor√°rio: ${data.time}
üîπ Servi√ßo: ${data.service}
üë®‚Äçüíº Profissional: ${data.professional}

üí° Lembre-se de chegar 10 minutos antes!

Qualquer imprevisto, entre em contato conosco! üì±`,
    reminder12h: (data) => `‚è∞ *Aviso: Seu agendamento √© em breve!*

Ol√° *${data.clientName}*!

Seu agendamento na *${data.businessName}* √© hoje:

üóìÔ∏è *Data: ${data.date}*
‚è∞ Hor√°rio: ${data.time}  
üîπ Servi√ßo: ${data.service}
üë®‚Äçüíº Profissional: ${data.professional}

Estamos te esperando! üòä`,
    reminder2h: (data) => `‚ö° *Lembrete: Seu hor√°rio √© em 2 horas!*

Ol√° *${data.clientName}*!

N√£o esque√ßa do seu agendamento:

‚è∞ *Hor√°rio: ${data.time}* (em 2 horas)
üîπ Servi√ßo: ${data.service}  
üë®‚Äçüíº Profissional: ${data.professional}

J√° estamos nos preparando para te receber! üéØ`,
    reminder1h: (data) => `‚è∞ *Lembrete: Seu hor√°rio √© em 1 hora!*

Ol√° *${data.clientName}*!

N√£o esque√ßa do seu agendamento de hoje:

‚è∞ *Hor√°rio: ${data.time}* (em 1 hora)
üîπ Servi√ßo: ${data.service}  
üë®‚Äçüíº Profissional: ${data.professional}

Se precisar reagendar, fale conosco.`,
    reminder30min: (data) => `üöÄ *Falta pouco: Seu hor√°rio √© em 30 minutos!*

Ol√° *${data.clientName}*!

Seu atendimento est√° chegando:

‚è∞ *Hor√°rio: ${data.time}* (em 30 minutos)
üîπ Servi√ßo: ${data.service}  
üë®‚Äçüíº Profissional: ${data.professional}

Estamos te esperando!`,
    reactivation: (data) => `üåü *Sentimos sua falta!*

Ol√° *${data.clientName}*! üòä

Notamos que voc√™ n√£o nos visita h√° um tempo na *${data.businessName}*!

Estamos ansiosos para receb√™-lo de novo.

Reserve seu hor√°rio quando quiser, ser√° um prazer rev√™-lo!

ÔøΩÔ∏è Agende j√°: ${data.customLink}
‚è∞ Oferta v√°lida at√© o final do m√™s!

Estamos ansiosos para te receber novamente! ‚ú®`,
};
// Evolution API integration (Client-side version)
function sendWhatsAppMessage(message) {
    return __awaiter(this, void 0, void 0, function* () {
        try {
            if (process.env.NODE_ENV === 'development') {
                console.log(`üì§ [Client] Enviando mensagem WhatsApp via API Route...`);
                console.log(`üì± Para: ${message.to}`);
                console.log(`üìù Tipo: ${message.type}`);
            }
            // Obter token do localStorage
            const token = localStorage.getItem('auth_token');
            if (process.env.NODE_ENV === 'development') {
                console.log('üîç [Client] Token encontrado:', token ? '‚úÖ Sim' : '‚ùå N√£o');
            }
            const headers = {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            };
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }
            const response = yield fetch('/api/whatsapp/send', {
                method: 'POST',
                headers,
                body: JSON.stringify({
                    to: message.to,
                    message: message.message,
                    type: message.type
                })
            });
            const responseData = yield response.json();
            if (response.ok && responseData.success) {
                if (process.env.NODE_ENV === 'development') {
                    console.log('‚úÖ [Client] Mensagem enviada com sucesso!');
                    console.log('üìã [Client] Resposta:', responseData);
                }
                return true;
            }
            else {
                if (process.env.NODE_ENV === 'development') {
                    console.error('‚ùå [Client] Falha ao enviar mensagem');
                    console.error('üìã Status:', response.status);
                    console.error('üìã Resposta:', responseData);
                }
                return false;
            }
        }
        catch (error) {
            if (process.env.NODE_ENV === 'development') {
                console.error('‚ùå [Client] Erro ao conectar com API:', error);
            }
            return false;
        }
    });
}
// Format phone number for WhatsApp API (Brazilian format)
function formatPhoneNumber(phone) {
    if (!phone)
        return '';
    // Remove all non-numeric characters
    const cleaned = phone.replace(/\D/g, "");
    if (process.env.NODE_ENV === 'development') {
        console.log(`üìû Formatando n√∫mero: "${phone}" -> "${cleaned}"`);
    }
    // Brazilian phone number patterns
    if (cleaned.length === 13 && cleaned.startsWith('55')) {
        // Already in international format: 5511999999999
        if (process.env.NODE_ENV === 'development') {
            console.log(`‚úÖ N√∫mero j√° no formato internacional: ${cleaned}`);
        }
        return cleaned;
    }
    else if (cleaned.length === 11) {
        // Brazilian format with area code: 11999999999
        const formatted = `55${cleaned}`;
        if (process.env.NODE_ENV === 'development') {
            console.log(`‚úÖ Adicionado c√≥digo do pa√≠s: ${formatted}`);
        }
        return formatted;
    }
    else if (cleaned.length === 10) {
        // Old Brazilian format without 9: 1199999999
        const formatted = `5511${cleaned.substring(2)}`;
        if (process.env.NODE_ENV === 'development') {
            console.log(`‚úÖ Formato antigo convertido: ${formatted}`);
        }
        return formatted;
    }
    else if (cleaned.length === 9) {
        // Only the number without area code: 999999999
        const formatted = `5511${cleaned}`;
        if (process.env.NODE_ENV === 'development') {
            console.log(`‚úÖ Adicionado DDD 11: ${formatted}`);
        }
        return formatted;
    }
    // Return as is if doesn't match common Brazilian patterns
    if (process.env.NODE_ENV === 'development') {
        console.log(`‚ö†Ô∏è Formato n√£o reconhecido, retornando como est√°: ${cleaned}`);
    }
    return cleaned;
}
// Check Evolution API instance status (Client-side version)
function checkWhatsAppStatus() {
    return __awaiter(this, void 0, void 0, function* () {
        try {
            if (process.env.NODE_ENV === 'development') {
                console.log('üîç [Client] Verificando status via API Route...');
            }
            const response = yield fetch('/api/whatsapp/status', {
                method: 'GET',
                headers: {
                    'Accept': 'application/json'
                }
            });
            if (response.ok) {
                const data = yield response.json();
                if (process.env.NODE_ENV === 'development') {
                    console.log('üìã [Client] Status recebido:', data);
                }
                return data;
            }
            else {
                const errorData = yield response.json().catch(() => ({ message: 'Erro desconhecido' }));
                if (process.env.NODE_ENV === 'development') {
                    console.error('‚ùå [Client] Erro ao verificar status:', errorData);
                }
                return {
                    connected: false,
                    instanceName: null,
                    error: `HTTP ${response.status}: ${errorData.message || 'Erro na API'}`
                };
            }
        }
        catch (error) {
            if (process.env.NODE_ENV === 'development') {
                console.error('‚ùå [Client] Erro ao conectar com API:', error);
            }
            return {
                connected: false,
                instanceName: null,
                error: error instanceof Error ? error.message : 'Erro de conex√£o'
            };
        }
    });
}
// Schedule WhatsApp reminders
function scheduleReminders(appointmentData) {
    const now = new Date();
    const appointmentTime = appointmentData.appointmentDateTime;
    // Calculate reminder times
    const reminder24h = new Date(appointmentTime.getTime() - 24 * 60 * 60 * 1000);
    const reminder2h = new Date(appointmentTime.getTime() - 2 * 60 * 60 * 1000);
    // Schedule 24-hour reminder
    if (reminder24h > now) {
        const delay24h = reminder24h.getTime() - now.getTime();
        setTimeout(() => __awaiter(this, void 0, void 0, function* () {
            const message = exports.whatsappTemplates.reminder24h(appointmentData);
            yield sendWhatsAppMessage({
                to: formatPhoneNumber(appointmentData.clientPhone),
                message,
                type: "reminder",
            });
        }), delay24h);
    }
    // Schedule 2-hour reminder
    if (reminder2h > now) {
        const delay2h = reminder2h.getTime() - now.getTime();
        setTimeout(() => __awaiter(this, void 0, void 0, function* () {
            const message = exports.whatsappTemplates.reminder2h(appointmentData);
            yield sendWhatsAppMessage({
                to: formatPhoneNumber(appointmentData.clientPhone),
                message,
                type: "reminder",
            });
        }), delay2h);
    }
}
